# 天气提醒功能实现总结

## 已完成的工作

### 1. 创建 WeatherReminder 类
- **位置**: `/src/main/kotlin/me/xiaozhangup/bot/func/WeatherReminder.kt`
- **功能**: 每天早上 7:30 定时发送天气提醒到指定的 QQ 群

### 2. 主要特性
- ✅ 基于 `EventUnit` 的标准实现，与 `TaskAbstract` 一致
- ✅ 使用 `OpenWeatherClient` 获取天气数据
- ✅ 支持配置文件 (`weather_reminder.properties`)
- ✅ 支持多群发送（逗号分隔）
- ✅ 自动调度，每天早上 7:30 定时发送
- ✅ 完善的日志记录
- ✅ 异常处理机制

### 3. 配置文件
- **示例文件**: `weather_reminder.properties.example`
- **配置项**:
  - `api.key`: OpenWeather API 密钥（必填）
  - `target.groups`: 目标群号列表，逗号分隔（必填）
  - `city`: 城市名称，英文（可选，默认 Beijing）

### 4. 注册到系统
- 已在 `OverflowBot.kt` 中注册 `WeatherReminder()`
- 插件启动时自动初始化并开始调度

### 5. 文档
- **使用文档**: `/doc/weather/README.md`
- 包含详细的配置说明、功能介绍和注意事项

## 使用方法

### 步骤 1: 配置
在插件数据目录创建 `weather_reminder.properties` 文件：

```properties
api.key=你的OpenWeather_API_Key
target.groups=123456789,987654321
city=Shanghai
```

### 步骤 2: 重启插件
配置完成后重启插件，功能即可生效。

### 步骤 3: 查看日志
启动时会在日志中看到：
```
[WeatherReminder] Weather reminder initialized. Target groups: [123456789, 987654321], City: Shanghai
[WeatherReminder] Next weather report scheduled at: 2026-02-13T07:30 (in xxxms)
```

## 技术实现细节

### 定时调度机制
1. 使用 `submitDelay` 计算到下一个 7:30 的延迟时间
2. 如果当前时间已过 7:30，则调度到明天
3. 发送完成后，递归调用 `scheduleNextWeatherReport()` 安排下一次

### 天气数据格式
```
☀️ 早安！今日天气播报
━━━━━━━━━━━━━━━
📍 城市: Shanghai
🌡️ 温度: 15.5°C
🤔 体感: 14.2°C
📊 温度范围: 12.0°C ~ 18.0°C
💧 湿度: 65%
🌀 气压: 1013 hPa
💨 风速: 3.5 m/s
☁️ 天气: 多云
━━━━━━━━━━━━━━━
祝你有美好的一天！
```

### 依赖关系
- `OpenWeatherClient`: 天气数据获取
- `EventUnit`: 事件单元基类
- `TaskUtils`: 任务调度工具
- `LoggerUtils`: 日志工具
- `FileUtils`: 配置文件读取
- `ContactUtils`: 群组访问

## 注意事项

1. **API Key**: 需要在 OpenWeatherMap 注册并获取免费 API Key
2. **群号格式**: 确保群号正确，机器人已加入这些群
3. **城市名称**: 必须使用英文名称（如 Beijing, Shanghai）
4. **时区**: 使用系统默认时区
5. **配置更新**: 修改配置后需重启插件

## 测试建议

1. 首次使用时可以先配置一个测试群
2. 如果想立即测试，可以临时修改代码中的 `LocalTime.of(7, 30)` 为当前时间后的几分钟
3. 查看日志确认调度是否正常
4. 检查群消息确认格式是否正确

## 可能的扩展

未来可以考虑添加：
- [ ] 自定义发送时间
- [ ] 多城市支持
- [ ] 天气预警功能
- [ ] 自定义消息模板
- [ ] 周末/节假日跳过
- [ ] 手动触发查询命令

